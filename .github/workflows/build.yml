name: Apache Golden Image - GCP

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  # ----------------------------
  # JOB 0: MOLECULE TEST
  # ----------------------------
  molecule:
    runs-on: ubuntu-latest
  
    env:
      GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      GCP_SERVICE_ACCOUNT_FILE: ${{ secrets.SA_KEY }}
  
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: GCP Auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.SA_KEY }}
          export_environment_variables: true

      # - name: Check GCP Project
      #   run: |
      #     echo "GCP_PROJECT_ID=$GCP_PROJECT_ID"
      #     gcloud auth activate-service-account --key-file="$GCP_SERVICE_ACCOUNT_FILE"
      #     gcloud config set project "$GCP_PROJECT_ID"
      #     gcloud config get-value project


      - name: Install Ansible & Molecule
        run: |
          pip install 'molecule_gce'

      - name: Setup GCP Service Account
        run: |
          echo "${GCP_SERVICE_ACCOUNT_FILE}" > ${{ runner.temp }}/gcp_sa.json
          echo "GCP_SERVICE_ACCOUNT_FILE=${{ runner.temp }}/gcp_sa.json" >> $GITHUB_ENV

      - name: Install Molecule Requirements
        run: |
          cd ansible/roles/apache/molecule/default
          ansible-galaxy collection install -r requirements.yml

      - name: List files for debug
        run: ls -R ansible/roles/apache/molecule/default


      # - name: Run Molecule
      #   run: |
      #     # cd ansible/roles/apache/molecule/default
      #     # pwd
      #     # ls -l
      #     cd ansible/roles/apache
      #     molecule test -s default
          

  # ----------------------------
  # JOB 1: PACKER VALIDATE
  # ----------------------------
  validate:
    # needs: molecule
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Packer
        uses: hashicorp/setup-packer@v3

      - name: Install Ansible
        run: sudo apt-get update && sudo apt-get install -y ansible

      - name: GCP Auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.SA_KEY }}
          export_environment_variables: true

      - name: Set Project
        run: gcloud config set project ${{ secrets.GCP_PROJECT_ID }}

      - name: Packer Validate
        run: |
          cd packer
          packer init .
          packer validate -var "project_id=${{ secrets.GCP_PROJECT_ID }}" .

  # ----------------------------
  # JOB 2: BUILD IMAGE
  # ----------------------------
  build:
    needs: validate
    runs-on: ubuntu-latest
    outputs:
      IMAGE_NAME: ${{ steps.build_image.outputs.IMAGE_NAME }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Packer
        uses: hashicorp/setup-packer@v3

      - name: GCP Auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.SA_KEY }}
          export_environment_variables: true

      - name: Set Project
        run: gcloud config set project ${{ secrets.GCP_PROJECT_ID }}

      - name: Build Apache Golden Image
        id: build_image
        shell: bash
        run: |
          set -euo pipefail
          cd packer
          packer init .
          packer build -machine-readable \
            -var "project_id=${{ secrets.GCP_PROJECT_ID }}" . \
            | tee packer-output.log
          IMAGE_NAME=$(grep 'artifact,0,id' packer-output.log | cut -d',' -f6)
          if [ -z "$IMAGE_NAME" ]; then
            echo "ERROR: No image was created!"
            exit 1
          fi
          echo "IMAGE_NAME=$IMAGE_NAME"
          echo "IMAGE_NAME=$IMAGE_NAME" >> $GITHUB_OUTPUT

  # ----------------------------
  # JOB 3: TERRATEST
  # ----------------------------
  terratest:
    needs: build
    runs-on: ubuntu-latest
    env:
      IMAGE_NAME: ${{ needs.build.outputs.IMAGE_NAME }}

    steps:
      - uses: actions/checkout@v4

      - name: GCP Auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.SA_KEY }}
          export_environment_variables: true

      - name: Set Project
        run: gcloud config set project ${{ secrets.GCP_PROJECT_ID }}

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: 1.21

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      # ✅ INSTALL OPA (CONFTST)
      - name: Install Conftest (OPA)
        run: |
          wget -qO- https://github.com/open-policy-agent/conftest/releases/latest/download/conftest_Linux_x86_64.tar.gz | tar xz
          sudo mv conftest /usr/local/bin/conftest
          conftest --version

      - name: Run Terratest
        run: |
          cd test
          go mod tidy
          GCP_PROJECT=${{ secrets.GCP_PROJECT_ID }} \
          IMAGE_NAME=$IMAGE_NAME \
          go test -v -timeout 30m ./integration

  # ----------------------------
  # JOB 4: DELETE IMAGE (ONLY IF TERRATEST FAILS)
  # ----------------------------
  cleanup:
    needs: [build, terratest]
    if: needs.terratest.result == 'failure'
    runs-on: ubuntu-latest
    env:
      IMAGE_NAME: ${{ needs.build.outputs.IMAGE_NAME }}

    steps:
      - name: GCP Auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.SA_KEY }}
          export_environment_variables: true

      - name: Set Project
        run: gcloud config set project ${{ secrets.GCP_PROJECT_ID }}

      - name: Delete Bad Image
        run: |
          echo "❌ Terratest failed. Deleting bad image: $IMAGE_NAME"
          gcloud compute images delete $IMAGE_NAME \
            --project=${{ secrets.GCP_PROJECT_ID }} --quiet




# name: Apache Golden Image - GCP

# on:
#   push:
#     branches: ["main"]
#   workflow_dispatch:

# # ----------------------------
# #  JOB 1: PACKER VALIDATE
# # ----------------------------
# jobs:
#   validate:
#     runs-on: ubuntu-latest
#     steps:
#     - uses: actions/checkout@v4

#     - name: Setup Packer
#       uses: hashicorp/setup-packer@v3

#     - name: Install Ansible
#       run: sudo apt-get update && sudo apt-get install -y ansible

#     - name: GCP Auth
#       uses: google-github-actions/auth@v2
#       with:
#         credentials_json: ${{ secrets.SA_KEY }}
#         export_environment_variables: true

#     - name: Set Project
#       run: gcloud config set project ${{ secrets.GCP_PROJECT_ID }}

#     - name: Packer Validate
#       run: |
#         cd packer
#         packer init .
#         packer validate -var "project_id=${{ secrets.GCP_PROJECT_ID }}" .


# # ----------------------------
# #  JOB 2: BUILD IMAGE
# # ----------------------------
#   build:
#     needs: validate
#     runs-on: ubuntu-latest
#     outputs:
#       IMAGE_NAME: ${{ steps.build_image.outputs.IMAGE_NAME }}
#     steps:
#     - uses: actions/checkout@v4
#     - uses: hashicorp/setup-packer@v3

#     - name: GCP Auth
#       uses: google-github-actions/auth@v2
#       with:
#         credentials_json: ${{ secrets.SA_KEY }}
#         export_environment_variables: true

#     - name: Set Project
#       run: gcloud config set project ${{ secrets.GCP_PROJECT_ID }}

#     - name: Build Apache Golden Image
#       id: build_image
#       run: |
#         set -euo pipefail
#         cd packer

#         packer init .
#         packer build -machine-readable \
#           -var "project_id=${{ secrets.GCP_PROJECT_ID }}" . | tee packer.log

#         IMAGE_NAME=$(grep 'artifact,0,id' packer.log | cut -d',' -f6)
#         if [ -z "$IMAGE_NAME" ]; then
#           echo "ERROR: Image not created"
#           exit 1
#         fi
#         echo "IMAGE_NAME=$IMAGE_NAME" >> "$GITHUB_OUTPUT"


# # ----------------------------
# #  JOB 3: TRIVY IMAGE SECURITY SCAN
# # ----------------------------
#   trivy:
#     needs: build
#     runs-on: ubuntu-latest
#     env:
#       IMAGE_NAME: ${{ needs.build.outputs.IMAGE_NAME }}
#     steps:
#     - uses: google-github-actions/auth@v2
#       with:
#         credentials_json: ${{ secrets.SA_KEY }}

#     - name: Set Project
#       run: gcloud config set project ${{ secrets.GCP_PROJECT_ID }}

#     - name: Install Trivy
#       run: |
#         curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sudo sh -s -- -b /usr/local/bin

#     - name: Create Temp Scan VM
#       run: |
#         gcloud compute instances create trivy-vm \
#           --zone=us-central1-a \
#           --image=$IMAGE_NAME \
#           --metadata=startup-script="#!/bin/bash
#           echo 'Temp VM ready for Trivy scan'"

#     - name: Wait for VM to be Ready
#       run: sleep 30  # optional wait for VM to fully boot

#     - name: Trivy Scan VM Disk
#       run: |
#         # Mount the VM disk locally or SSH in for scanning
#         # Here we assume scanning via SSH for simplicity
#         VM_NAME=trivy-vm
#         gcloud compute ssh $VM_NAME --zone=us-central1-a --command "
#           sudo apt update && sudo apt install -y curl
#           curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sudo sh -s -- -b /usr/local/bin
#           # Scan essential directories only
#           sudo trivy fs --severity HIGH,CRITICAL --exit-code 1 /usr /etc /var --scanners vuln --timeout 10m
#         "

#     - name: Delete Temp VM
#       if: always()
#       run: |
#         gcloud compute instances delete trivy-vm --zone=us-central1-a --quiet


# # ----------------------------
# #  JOB 4: TERRATEST (AFTER TRIVY PASSES)
# # ----------------------------
#   terratest:
#     needs: trivy
#     runs-on: ubuntu-latest
#     env:
#       IMAGE_NAME: ${{ needs.build.outputs.IMAGE_NAME }}
#     steps:
#     - uses: actions/checkout@v4
#     - uses: google-github-actions/auth@v2
#       with:
#         credentials_json: ${{ secrets.SA_KEY }}
#     - name: Set Project
#       run: gcloud config set project ${{ secrets.GCP_PROJECT_ID }}
#     - uses: actions/setup-go@v5
#       with:
#         go-version: 1.21
#     - uses: hashicorp/setup-terraform@v3
#     - name: Run Terratest
#       run: |
#         cd test
#         go mod tidy
#         GCP_PROJECT=${{ secrets.GCP_PROJECT_ID }} \
#         IMAGE_NAME=$IMAGE_NAME \
#         go test -v -timeout 30m ./integration


# # ----------------------------
# #  JOB 5: CLEANUP BAD IMAGE IF FAILS
# # ----------------------------
#   cleanup:
#     needs: [build, trivy, terratest]
#     if: always() && (needs.trivy.result == 'failure' || needs.terratest.result == 'failure')
#     runs-on: ubuntu-latest
#     env:
#       IMAGE_NAME: ${{ needs.build.outputs.IMAGE_NAME }}
#     steps:
#     - uses: google-github-actions/auth@v2
#       with:
#         credentials_json: ${{ secrets.SA_KEY }}
#     - name: Set Project
#       run: gcloud config set project ${{ secrets.GCP_PROJECT_ID }}
#     - name: Delete Bad Image
#       run: |
#         echo "❌ Deleting bad image: $IMAGE_NAME"
#         gcloud compute images delete $IMAGE_NAME --quiet











# name: Apache Golden Image - GCP

# on:
#   push:
#     branches: ["main"]
#   workflow_dispatch:

# # ----------------------------
# #  JOB 1: PACKER VALIDATE
# # ----------------------------
# jobs:
#   validate:
#     runs-on: ubuntu-latest

#     steps:
#     - uses: actions/checkout@v4

#     - name: Setup Packer
#       uses: hashicorp/setup-packer@v3

#     - name: Install Ansible
#       run: sudo apt-get update && sudo apt-get install -y ansible

#     - name: GCP Auth
#       uses: google-github-actions/auth@v2
#       with:
#         credentials_json: ${{ secrets.SA_KEY }}
#         export_environment_variables: true

#     - name: Set Project
#       run: gcloud config set project ${{ secrets.GCP_PROJECT_ID }}

#     - name: Packer Validate
#       run: |
#         cd packer
#         packer init .
#         packer validate -var "project_id=${{ secrets.GCP_PROJECT_ID }}" .


# # ----------------------------
# #  JOB 2: BUILD IMAGE (WITH GOSS INSIDE PACKER)
# # ----------------------------
#   build:
#     needs: validate
#     runs-on: ubuntu-latest

#     outputs:
#       IMAGE_NAME: ${{ steps.build_image.outputs.IMAGE_NAME }}

#     steps:
#     - uses: actions/checkout@v4
#     - uses: hashicorp/setup-packer@v3

#     - name: GCP Auth
#       uses: google-github-actions/auth@v2
#       with:
#         credentials_json: ${{ secrets.SA_KEY }}
#         export_environment_variables: true

#     - name: Set Project
#       run: gcloud config set project ${{ secrets.GCP_PROJECT_ID }}

#     - name: Build Apache Golden Image
#       id: build_image
#       run: |
#         set -euo pipefail
#         cd packer

#         packer init .

#         packer build -machine-readable \
#           -var "project_id=${{ secrets.GCP_PROJECT_ID }}" . | tee packer.log

#         IMAGE_NAME=$(grep 'artifact,0,id' packer.log | cut -d',' -f6)

#         if [ -z "$IMAGE_NAME" ]; then
#           echo "ERROR: Image not created"
#           exit 1
#         fi

#         echo "IMAGE_NAME=$IMAGE_NAME" >> "$GITHUB_OUTPUT"


# # ----------------------------
# #  JOB 3: TRIVY IMAGE SECURITY SCAN ( FIXED)
# # ----------------------------
#   trivy:
#     needs: build
#     runs-on: ubuntu-latest

#     env:
#       IMAGE_NAME: ${{ needs.build.outputs.IMAGE_NAME }}

#     steps:
#     - uses: google-github-actions/auth@v2
#       with:
#         credentials_json: ${{ secrets.SA_KEY }}

#     - name: Set Project
#       run: gcloud config set project ${{ secrets.GCP_PROJECT_ID }}

#     - name: Install Trivy
#       run: |
#         curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sudo sh -s -- -b /usr/local/bin

#     #  Create temp VM from image for scanning
#     - name: Create Temp Scan VM
#       run: |
#         gcloud compute instances create trivy-vm \
#           --zone=us-central1-a \
#           --image=$IMAGE_NAME

#     #  Trivy filesystem scan
#     - name: Trivy Scan VM Disk
#       run: |
#         trivy fs --severity HIGH,CRITICAL --exit-code 1 /

#     #  Remove temp VM
#     - name: Delete Temp VM
#       run: |
#         gcloud compute instances delete trivy-vm --zone=us-central1-a --quiet


# # ----------------------------
# #  JOB 4: TERRATEST (ONLY AFTER TRIVY  PASSES)
# # ----------------------------
#   terratest:
#     needs: trivy
#     runs-on: ubuntu-latest

#     env:
#       IMAGE_NAME: ${{ needs.build.outputs.IMAGE_NAME }}

#     steps:
#     - uses: actions/checkout@v4

#     - uses: google-github-actions/auth@v2
#       with:
#         credentials_json: ${{ secrets.SA_KEY }}

#     - name: Set Project
#       run: gcloud config set project ${{ secrets.GCP_PROJECT_ID }}

#     - uses: actions/setup-go@v5
#       with:
#         go-version: 1.21

#     - uses: hashicorp/setup-terraform@v3

#     - name: Run Terratest
#       run: |
#         cd test
#         go mod tidy

#         GCP_PROJECT=${{ secrets.GCP_PROJECT_ID }} \
#         IMAGE_NAME=$IMAGE_NAME \
#         go test -v -timeout 30m ./integration


# # ----------------------------
# #  JOB 5: DELETE IMAGE IF TRIVY OR TERRATEST FAILS 
# # ----------------------------
#   cleanup:
#     needs: [build, trivy, terratest]
#     if: always() && (needs.trivy.result == 'failure' || needs.terratest.result == 'failure')
#     runs-on: ubuntu-latest

#     env:
#       IMAGE_NAME: ${{ needs.build.outputs.IMAGE_NAME }}

#     steps:
#     - uses: google-github-actions/auth@v2
#       with:
#         credentials_json: ${{ secrets.SA_KEY }}

#     - name: Set Project
#       run: gcloud config set project ${{ secrets.GCP_PROJECT_ID }}

#     - name: Delete Bad Image
#       run: |
#         echo "❌ Deleting bad image: $IMAGE_NAME"
#         gcloud compute images delete $IMAGE_NAME --quiet












# name: Apache Golden Image - GCP   

# on:
#   push:
#     branches: ["main"]
#   workflow_dispatch:

# jobs:
#   build-apache-image:
#     runs-on: ubuntu-latest

#     steps:
#     - uses: actions/checkout@v4

#     - name: Setup Packer
#       uses: hashicorp/setup-packer@v3

#     - name: Install Ansible
#       run: sudo apt-get update && sudo apt-get install -y ansible

#     - name: GCP Auth
#       uses: google-github-actions/auth@v2
#       with:
#         credentials_json: ${{ secrets.SA_KEY }}

#     - name: Set Project
#       run: gcloud config set project ${{ secrets.GCP_PROJECT_ID }}

#     #  UNIT TEST
#     - name: Packer Validate
#       run: |
#         cd packer
#         packer init .
#         packer validate -var "project_id=${{ secrets.GCP_PROJECT_ID }}" .

#     # #  BUILD IMAGE
#     # - name: Build Apache Image
#     #   run: |
#     #     cd packer
#     #     packer build -var "project_id=${{ secrets.GCP_PROJECT_ID }}" .

#     # - name: Build Apache Golden Image
#     #   id: packer_build
#     #   run: |
#     #     cd packer
#     #     packer build apache-image \
#     #       -var "project_id=${{ secrets.GCP_PROJECT_ID }}" . > packer-output.log

#     # - name: Build Apache Golden Image
#     #   id: packer_build
#     #   run: |
#     #     cd packer
#     #     packer init .
#     #     packer validate -var "project_id=${{ secrets.GCP_PROJECT_ID }}" .
#     #     packer build -var "project_id=${{ secrets.GCP_PROJECT_ID }}" . | tee packer-output.log

#     - name: Build Apache Golden Image
#       id: packer_build
#       run: |
#         set -euo pipefail   # This ensures the step FAILS if packer fails
#         cd packer
    
#         packer init .
#         packer validate -var "project_id=${{ secrets.GCP_PROJECT_ID }}" .
    
#         packer build -machine-readable -var "project_id=${{ secrets.GCP_PROJECT_ID }}" . | tee packer-output.log
    
#         # -------------------------------
#         # Capture the newly created image
#         # -------------------------------
#         IMAGE_NAME=$(grep 'artifact,0,id' packer-output.log | cut -d',' -f6)
    
#         if [ -z "$IMAGE_NAME" ]; then
#           echo "ERROR: No image was created by Packer!"
#           exit 1
#         fi
    
#         echo "IMAGE_NAME=$IMAGE_NAME"
#         echo "IMAGE_NAME=$IMAGE_NAME" >> $GITHUB_ENV


       


#     # - name: Capture Image Name
#     #   if: success()
#     #   id: capture_image
#     #   run: |
#     #     IMAGE_NAME=$(gcloud compute images list \
#     #       --project=${{ secrets.GCP_PROJECT_ID }} \
#     #       --filter="name~'apache'" \
#     #       --sort-by=~creationTimestamp \
#     #       --limit=1 \
#     #       --format="value(name)")
    
#     #     if [ -z "$IMAGE_NAME" ]; then
#     #       echo "ERROR: Image not found!"
#     #       exit 1
#     #     fi
    
#     #     echo "IMAGE_NAME=$IMAGE_NAME"
#     #     echo "IMAGE_NAME=$IMAGE_NAME" >> $GITHUB_ENV



#     # ----------------------------
#     # SETUP GO FOR TERRATEST
#     # ----------------------------
#     - name: Setup Go
#       uses: actions/setup-go@v5
#       with:
#         go-version: 1.21


#     - name: Setup Terraform
#       uses: hashicorp/setup-terraform@v3

#     - name: Set Terraform Binary for Terratest
#       run: echo "TERRATEST_TERRAFORM_BINARY=terraform" >> $GITHUB_ENV


#     # ----------------------------
#     #  INTEGRATION TEST (TERRATEST)
#     # ----------------------------
#     - name: Run Terratest on Image
#       id: terratest
#       run: |
#         cd test
#         go mod tidy
#         GCP_PROJECT=${{ secrets.GCP_PROJECT_ID }} \
#         IMAGE_NAME=${{ env.IMAGE_NAME }} \
#         go test -v -timeout 30m ./integration
    


#     - name: Delete Image If Terratest Fails
#       if: steps.terratest.outcome == 'failure'
#       run: |
#         echo "❌ Terratest failed. Deleting bad image: $IMAGE_NAME"
#         gcloud compute images delete $IMAGE_NAME \
#           --project=${{ secrets.GCP_PROJECT_ID }} --quiet



